#!/usr/bin/env perl
use strict;
use v5.10.1; # for say and switch
use autodie qw(:all);
use IPC::System::Simple qw(run runx capture capturex $EXITVAL EXIT_ANY);
binmode(STDOUT, ":utf8");
binmode(STDERR, ":utf8");
use Encode;
use utf8;
@ARGV = map {decode_utf8 $_} @ARGV;


## start code-generator "^\\s *#\\s *"
# generate-getopt -s perl @ask-to-whom @:send-to @:extra-send-text @:image
## end code-generator
## start generated code
use Getopt::Long;

Getopt::Long::Configure("default");



my $ask_to_whom = 0;
my $extra_send_text = "";
my $image = "";
my $send_to = "";

my $handler_help = sub {
    print ;
    print "\n\n选项和参数：\n";
    printf "%6s", '';
    printf "%-24s", '--[no]ask-to-whom';
    if (length('--[no]ask-to-whom') > 24 and length() > 0) {
        print "\n";
        printf "%30s", "";
    }
    printf "%s", ;
    print "\n";
    printf "%6s", '';
    printf "%-24s", '--extra-send-text=EXTRA-SEND-TEXT';
    if (length('--extra-send-text=EXTRA-SEND-TEXT') > 24 and length() > 0) {
        print "\n";
        printf "%30s", "";
    }
    printf "%s", ;
    print "\n";
    printf "%6s", '';
    printf "%-24s", '--image=IMAGE';
    if (length('--image=IMAGE') > 24 and length() > 0) {
        print "\n";
        printf "%30s", "";
    }
    printf "%s", ;
    print "\n";
    printf "%6s", '';
    printf "%-24s", '--send-to=SEND-TO';
    if (length('--send-to=SEND-TO') > 24 and length() > 0) {
        print "\n";
        printf "%30s", "";
    }
    printf "%s", ;
    print "\n";

    exit(0);
};

GetOptions (
    'ask-to-whom!' => \$ask_to_whom,
    'extra-send-text=s' => \$extra_send_text,
    'image=s' => \$image,
    'send-to=s' => \$send_to,
    'help|h!' => \&$handler_help,
);


## end generated code
use String::ShellQuote;

sub quote_lua_str($) {
    my @command = ("str.quote.lua", "$_[0]");
    my $command = join(" ", shell_quote(@command));
    return scalar qx($command);
}

if (not $image) {
    if ($ARGV[0] =~ m/^image:\s*(\S+.*?)\s*$/) {
        $image = $1;
    }
}

sub getText() {
    my $text;
    if (@ARGV) {
        $text = join(" ", @ARGV);
    } else {
        $text = join("", <>);
    }
    $text =~ s,\s*$,,;              # get rid of empty lines at the end.
    return $text;
}

if ($ask_to_whom or $send_to) {
  my $whom;
  if ($send_to) {
    $whom = $send_to
  } else {
    chomp($whom = qx(input-lock -l Wrench-post select-args -a pengyouquan\@\@wx -a 朋友圈\@\@wx --ask-for-input -1 --select-from-history-too -o -p "你想给谁发送消息"));
  }

  if ($whom eq 'pengyouquan@@wx' or $whom eq '朋友圈@@wx' ) {
      my $post_text = sprintf("wrench_share_to_weixin(%s)", quote_lua_str(getText()));
      system("Wrench.sh", $post_text);
      exit 0;
  }

  my $call_text = sprintf("wrench_call(%s)", quote_lua_str($whom));
  system("log-run", "Wrench.sh", $call_text);

  if (system("yes-or-no-p '已经找到你想发送消息的人了么？'") != 0) {
    system("bhj-notify", "Wrench-post", "Can't find $whom to post, please fix it");
    exit 1;
  }
}

if ($image) {
    my $post_text = sprintf("wrench_picture(%s)", quote_lua_str($image));
    say STDERR "sending image: $post_text";

    system("Wrench.sh", $post_text);

    exit 0;
}

my $text = getText();

use File::Slurp;

append_file("$ENV{HOME}/.cache/system-config/Wrench-post.history",
            encode_utf8 <<EOF
----------------------------------------------------------------
$text


EOF
        );

my @cur_at_end;

my $at_someone_regexp = qr((\@\@(\w+)(\s| )?)+);

my %cue_screens = (
    "com.alibaba.android.rimet/com.alibaba.android.dingtalkim.activities.ChatMsgActivity" => 1,
    "com.tencent.mm/com.tencent.mm.ui.chatting.ChattingUI" => 1,
    "com.tencent.mm/com.tencent.mm.ui.LauncherUI" => 1,
);

my $how_to_post = 'nil';
if ($text =~ m/$at_someone_regexp/ and $cue_screens{qx(adb-top-activity)}) {
    while ($text =~ s,$at_someone_regexp,,) {
        my $pre = $`;
        my $post = $';
        my $at_whom = $&;
        # say STDERR "at_whom is $at_whom";

        if ($pre) {
            my $post_text = sprintf("wrench_post(%s, %s)", quote_lua_str($`), '"no-post"');
            system("Wrench.sh", $post_text);
        }

        my @at_whom = ();
        my @at_format = ();
        while ($at_whom =~ m,(\w+),g) {
            push @at_whom, $1;
            push @at_format, "%s";
        }
        my $at_format = join(", ", @at_format);


        my $command = sprintf("wrench_cue($at_format)", map {quote_lua_str $_} (@at_whom));
        system("Wrench.sh", $command);
        $text = $post;
    }
}

my $post_text = sprintf("wrench_post(%s, %s)", quote_lua_str($text), 'nil');

system("Wrench.sh", $post_text);

if ($extra_send_text) {
  system("Wrench-post", "--", "$extra_send_text");
}
